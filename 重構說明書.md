預測演算法重構企劃書 step 1
一、專案目標
建立一套高度模組化、多特徵融合、動態可擴展的新一代預測演算法框架。
所有預測結果、回測、分析、策略紀錄等均存於獨立新表 PredictionResult，不影響舊系統與資料結構。
目標：高頻調參、A/B test、快速灰度、策略研發與自動化運營，支援完整參數快照與專業回測指標。

二、資料物件與資料表（Model/Schema）
1. GameRound
用途：遊戲回合主體，沿用現有資料表。

2. TokenPrice
用途：行情快照，沿用現有資料表。

作為行情特徵計算的基礎資料源。

3. PredictionResult（新表，重構主軸）
用途：存放每回合每 token 的所有預測細節與策略快照，為新引擎所有產出和回測分析的核心表。

建議欄位設計如下：

欄位名	型別	說明
id	bigint	PK，自增
game_round_id	bigint	關聯 GameRound
token	string	代幣 symbol
predict_rank	int	預測排序名次（1=最高分）
predict_score	float	預測最終混合分數
elo_score	float	Elo 分數（標準化前）
momentum_score	float	Momentum 分數（標準化前）
volume_score	float	Volume 分數
norm_elo	float	Elo 標準化後分數
norm_momentum	float	Momentum 標準化後分數
norm_volume	float	Volume 標準化後分數
used_weights	json	各特徵混分權重（如 {"elo":0.7,"momentum":0.3}）
used_normalization	json	各特徵標準化方式（如 {"elo":"z-score"}）
strategy_tag	string	預測策略模板名（如 conservative、aggressive）
config_snapshot	json	全部策略參數快照（可選）
created_at	timestamp	建立時間

三、架構分層設計
1. 行情數據源層（MarketDataProvider）
接口：MarketDataProviderInterface

例：AlchemyProvider, DexScreenerProvider, WebSocketProvider

方法：fetchSnapshots(array $symbols, int $timestamp): array<TokenPrice>

2. 特徵計算層（FeatureProvider）
接口：FeatureProviderInterface

例：EloFeatureProvider, MomentumFeatureProvider, VolumeFeatureProvider, SocialHeatFeatureProvider

方法：extractFeatures(array $snapshots, array $history): array<symbol => score>

3. 分數標準化層（NormalizationStrategy）
接口：NormalizationStrategyInterface

例：ZScoreNormalization, MinMaxNormalization, IdentityNormalization

方法：normalize(array $values): array

4. 分數混合層（ScoreAggregator）
設計：可注入 feature/weight/normalization 策略

方法：aggregate(array $allFeatureScores): array

5. 預測主流程層（PredictionService）
組合數據源、特徵 provider、標準化策略、混分邏輯，產生完整預測分數與排序，並寫入 PredictionResult

支援多策略（ensemble）、A/B test、不同參數模板

6. 回測分析層（BacktestService）
支援單策略與矩陣策略自動化回測（Grid Search）

專業回測指標：勝率、保本率、Sharpe Ratio、最大回撤、單次最大盈虧、平均盈虧比

可批量寫入 PredictionResult 並產生分析報告

7. 配置與工廠模式
所有 provider、feature、weight、normalization 均於 config/prediction.php 配置

PredictionServiceFactory 負責自動組裝所有元件

四、完整偽代碼與配置說明
1. PredictionResult Model（資料表結構參考）
php
Copy
Edit
class PredictionResult {
    public int $id;
    public int $game_round_id;
    public string $token;
    public int $predict_rank;
    public float $predict_score;
    public float $elo_score;
    public float $momentum_score;
    public float $volume_score;
    public float $norm_elo;
    public float $norm_momentum;
    public float $norm_volume;
    public array $used_weights; // json
    public array $used_normalization; // json
    public string $strategy_tag;
    public array $config_snapshot; // json
    public string $created_at;
}
2. MarketDataProviderInterface
php
Copy
Edit
interface MarketDataProviderInterface {
    public function fetchSnapshots(array $symbols, int $timestamp): array; // 回傳 TokenPrice[]
}
3. FeatureProviderInterface
php
Copy
Edit
interface FeatureProviderInterface {
    public function extractFeatures(array $snapshots, array $history): array; // symbol => score
}
4. NormalizationStrategyInterface
php
Copy
Edit
interface NormalizationStrategyInterface {
    public function normalize(array $values): array;
}
5. ScoreAggregator
php
Copy
Edit
class ScoreAggregator {
    public function __construct(array $featureWeights, array $featureNormalizations) { ... }
    public function aggregate(array $allFeatureScores): array {
        // 各特徵用對應 normalization 處理
        // 用 featureWeights 加權混合
    }
}
6. PredictionService
php
Copy
Edit
class PredictionService {
    public function __construct(
        MarketDataProviderInterface $dataProvider,
        array $featureProviders,
        ScoreAggregator $aggregator
    ) { ... }

    public function predict(array $symbols, int $timestamp, array $history): array {
        // 取得行情
        // 各 provider 算分數
        // 標準化混分
        // 排序
        // 將每一 token 的所有細節寫入 PredictionResult
        // 回傳完整預測結果
    }
}
7. BacktestService
php
Copy
Edit
class BacktestService {
    public function __construct(PredictionService $service) { ... }
    public function runBacktest(array $rounds, array $strategyConfig): array { ... }
    public function gridSearch(array $rounds, array $paramMatrix): array { ... }
}
8. 配置文件與組裝工廠
php
Copy
Edit
// config/prediction.php
return [
    'default_data_provider' => DexScreenerProvider::class,
    'features' => [
        'elo' => true,
        'momentum' => true,
        'volume' => false,
    ],
    'feature_normalization' => [
        'elo' => 'z-score',
        'momentum' => 'min-max',
    ],
    'strategies' => [
        'conservative' => [
            'weights' => ['elo' => 0.7, 'momentum' => 0.3],
            'normalization' => ['elo'=>'z-score', 'momentum'=>'min-max'],
        ],
        // ...other strategies
    ],
];
php
Copy
Edit
class PredictionServiceFactory {
    public static function create(string $strategy): PredictionService {
        $config = require 'config/prediction.php';
        // 根據 $config 和 $strategy 組裝所有元件
    }
}
五、資料流與使用範例
單次預測流程：

php
Copy
Edit
$service = PredictionServiceFactory::create('conservative');
$result = $service->predict(['ETH', 'DOGE', 'SOL'], time(), $history);
// $result: [['symbol'=>'ETH', 'score'=>0.95], ...]
// 並自動寫入 PredictionResult 表
批量回測 + 最優參數尋找：

php
Copy
Edit
$backtest = new BacktestService($service);
$report = $backtest->runBacktest($historicalRounds, $strategyConfig);
// $report: ['win_rate'=>0.78, 'sharpe_ratio'=>1.52, ...]
參數矩陣批測（Grid Search）：

php
Copy
Edit
$paramMatrix = [
    'weights' => [
        ['elo'=>0.7, 'momentum'=>0.3],
        ['elo'=>0.5, 'momentum'=>0.5],
        // ...
    ],
    'normalization' => [
        ['elo'=>'z-score', 'momentum'=>'min-max'],
        // ...
    ]
];
$gridReport = $backtest->gridSearch($historicalRounds, $paramMatrix);
// 輸出最優權重、最佳 normalization、各種指標排行
六、進階優化與未來擴展
支援更多 FeatureProvider（如 NFT、社群、大戶行為等）

新策略可自由加入、回測與 production 無縫接軌

強化異常標註與風險管理，可用於自動風控

所有指標與細節皆可可視化（BI 連接或 API 對外）

線上、歷史全流統一，便於大規模 A/B 測試與策略灰度

七、專案交付規範
所有新表命名、資料流、接口等均以 PredictionResult 為中心設計，不動用舊表

每一層皆為獨立 class，接口註解清楚，易於測試與擴展

配置完全熱插拔，支援多策略、參數實驗，便於 AI 自動化產出

預留擴充欄位（如 config_snapshot）以因應未來複雜化需求
